# Timing Posts Telegram Bot

## Как начать использовать?

1. Скачайте `.jar` (конкретные ссылки будут приведены позже) или соберите проект. Чтобы собрать проект:
    1. Убедитесь, что у вас установлена `Java` (>= 1.7) и `Maven`
    1. Склонируйте проект с [Github](https://github.com/InsanusMokrassar/TimingPostsTelegramBot)
    2. В каталоге с проектом:
        1. Собираем проект с помощью команды для Maven `mvn clean package`
        2. Копируем файл из пути `$PROJECT_DIR/target/TimingPostsTelegramBot-1.0-jar-with-dependencies.jar` туда, где
        должен лежать бот
3. Настройте проект через написание конфига (шаблон конфигурации есть в корне 
[проекта на Github](https://github.com/InsanusMokrassar/TimingPostsTelegramBot))
4. Запустите командой `java -jar ./TimingPostsTelegramBot-1.0-jar-with-dependencies.jar
%ПУТЬ ДО КОНФИГУРАЦИОННОГО ФАЙЛА%`
5. Profit

## Возможности

### Что бот может?

Если кратко, назначением бота является автоматизация и нормализация создания и
публикации постов (совокупность сообщений) в каком-либо чате/канале. Публикация
происходит из чата/канала, выбранного как `sourceChat` путем выставления
соответствующего `sourceChatId`.

На данный момент готов тот минимум, который не позволит превратить место с
записями для постинга в помойку и при этом вполне себе постить записи по
расписанию. Итак, возможности:

* Возможность выбирать различные фильтры для постинга
    * Обычный фильтр - сначала лучшие
    * Обычный рандом - из лучших выбирается не самый старый, а случайный пост
    * "Умный фильтр", настраиваемый по периодам времени. В каждый период
    времени действует одна совокупность настроек:
        * Минимальный рейтинг, может быть не установлен, тогда считается, что
        минимального порога нет
        * Максимальный рейтинг, может быть не установлен, тогда считается, что
        максимального порога нет
        * Массив времени, по сути, пары "от"-"до"
        * Режим сортировки или "что выбрать?"
            * Восходящая - публикуются посты с минимальным рейтингом из
            выбранных
            * Нисходящая - публикуются посты с максимальным рейтингом из
            выбранных
            * Рандом - публикуются случайные посты из выбранных
* Поддержка форматов:
    * Изображения
    * Видео
    * Аудио
    * Голос
    * Текст
    * Медиагруппы (ВСЕГДА публикуются одним постом, но могут быть включены в
    другие посты)
    * Контакты
    * Геолокация
    * Документы
* Возможность указания отдельной группы/канала для ведения логов бота (по-умолчанию используется
канал/группа с запланированными постами)
* Наличие системы плагинов

#### Плагины

* Сборщик мусора
    * Отслеживает изменения лайков
    * Раз в какое-то время может проверять наличие постов с рейтингом ниже
    установленного и удалять их.
* Триггер постинга по таймауту
* Триггеры для системных действий, отлавливающие события от исходных чатов:
    * Начало поста
    * Фиксирование поста
    * Удаление поста
    * Получение наиболее одобренных постов
    * Получения списка рейтингов
    * Немедленная публикация

### Что планируется?

* Больше плагинов
    * Публикация по рейтингу
    * Сборщик мусора, который будет способен фильтровать записи в диапазоне или
    вне диапазона
* Больше фильтров постов
    * Добавление возможности постить не один пост за раз (точнее возможность
    есть, но фильтры её не используют)
    * Улучшение структуры фильтров
* Больше поддерживаемых форматов данных

Так или иначе, жду отзывы и предложения в [Telegram](https://t.me/insanusmokrassar), по
[email](mailto://ovsyannikov.alexey95@gmail.com).

# Секции конфигурации

В корне конфигурации лежат следующие параметры (учтите, что `ChatId` - именно **`id`**, не `username`):

* `targetChatId` - идентификатор чата, куда в итоге будут отправляться посты; число
* `sourceChatId` - идентификатор чата, откуда в итоге будут браться посты; число
* `logsChatId` - идентификатор чата, куда будут отправляться системные сообщения,
по-умолчанию будет равен `sourceChatId`; число
* `botToken` - токен `Telegram Bot` для доступа к API вида `123456789:ABCDEFGHIGKLMNOPQRSTUVWXYZabcdefghi`
* `proxy` - объект настройки `Socks5` прокси. Достаточно указать `{}` если
вы используете `shadowsocks`
    * `host` - `url` прокси, по-умолчанию - `localhost`
    * `port` - порт прокси, по-умолчанию - `1080`
    * `username` - имя пользователя для доступа к прокси через авторизацию
    * `password` - пароль для доступа к прокси через авторизацию
* `databaseConfig` - объект настройки базы данных. Включает следующие поля:
    * `username` - имя пользователя для доступа к базе данных
    * `password` - пароль для доступа к базе данных
    * `url` - путь для доступа к базе данных. Например,
    `jdbc:h2:mem:test;DB_CLOSE_DELAY=-1` может использоваться для базы данных
    "на раз", то есть, в памяти с использованием базы данных `h2`
    * `driver` - `classname` драйвера базы данных. Например, `org.h2.Driver` для
    использования драйвера `h2`
* `plugins` - список подключенных плагинов. Каждый плагин имеет следующие поля:
    * `classname` - полное пакетное имя класса плагина. Например,
    `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.triggers.TimerTriggerStrategy`
    для подключения плагина триггеринга постов по времени
    * `params` - объект настроек плагина. Например, в таком объекте для
    плагина из предыдущего пункта будет только одно поле и конфигурация
    будет выглядеть следующим образом:
        ```json
        {
          "classname": "com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.triggers.TimerTriggerStrategy",
          "params": {
            "delay": 3600000
          }
        }
        ```

## Ещё немного о плагинах

### Строго рекомендуемые к подключению

* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.base.callbacks.OnMessage` - подключение
реакции бота на сообщение по-умолчанию, то есть сохранение сообщения как части поста и фиксации
поста если начало поста было положено не в этом плагине (например, с помощью команды `/startPost`)
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.base.callbacks.OnMediaGroup` - подключение
реакции бота на сообщения, состоящие из медиагрупп (галереи), то есть сохранение сообщений как части ОДНОГО
поста и фиксации поста если начало поста было положено не в этом плагине (например, с помощью команды `/startPost`)
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.CallbackQueryReceivers.LikeReceiver` - плагин
стандартной реакции на на нажатие кнопки одобрения поста
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.CallbackQueryReceivers.DislikeReceiver` - плагин
стандартной реакции на на нажатие кнопки неодобрения поста
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.base.commands.StartPost` - подключение
команды `/startPost`, используемой для начала записи поста, состоящего из нескольких сообщений
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.base.commands.FixPost` - подключение
команды `/fixPost`, используемой для окончания записи поста, состоящего из нескольких сообщений и
фиксации в памяти бота
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.base.commands.DeletePost` - подключение
команды `/deletePost`, используемой для удаления поста бота
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.choosers.SmartChooser` - "smart" плагин выборщика
для постинга, имеет следующую структуру для параметра `params`:
    * `times` - список временнЫх настроек для выборщика, каждый объект
    которого содержит следующие параметры:
        * `minRate` - минимальный рейтинг для попадания в список
        кандидатов на выбор, если не указано - считается, что
        минимума нет
        * `maxRate` - максимальный рейтинг для попадания в список
        кандидатов на выбор, если не указано - считается, что
        максимума нет
        * `sort` - режим сортировки кандидатов на выборку
        * `time` - массив, в котором каждый первый элемент - начало
        времени, когда этот объект конфигурации применим, а каждый
        второй - конец такого времени
        * `timeOffset` - опциональное поле формата `+HH:mm`, где
            * `+` - знак смещения относительно `UTC`
            * `HH` - часы смещения
            * `mm` - минуты смещения
        * `count` - число постов, производимых за раз
* Плагины, `classname` которых оканчивается на `Forwarder` (например, `TextForwarder`) - форвардеры для публикации в целевом канале

### Опциональные плагины

* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.rating.commands.AvailableRates` - подключение
команды `availableRatings`, выдающей список из пар `рейтинг` : `число постов`
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.rating.commands.MostRated` - команда
`mostRated`, выдающая список из наиболее одобренных постов
* `com.github.insanusmokrassar.TimingPostsTelegramBot.plugins.commands.PublishPost` - команда
для немедленной публикации поста

## Описание команд, доступных после подключения плагинов

* `/startPost` используется в паре с `/fixPost`, сообщения между ними будут прикреплены к одному посту.
Можно не использовать для галерей (медиагрупп), поскольку такие группы определяются автоматически в
один пост. Пример (каждый пункт - отдельное сообщение):
    1. `/startPost`
    2. Тут какой-то текст
    3. Картиночка
    4. Еще что-то
    5. `/fixPost`
    
    Далее вас оповестят, что серия сообщений закреплена за одним постом и будет опубликована.
    Записи публикуются не по состоянию на момент создания, а по состоянию на момент перед
    публикацией. Кроме того, учтите, что бот не сможет удалять сообщения из постов, если они были
    отправлены более двух дней назад (специфика `Telegram`) - бот об этом оповестит в канале с
    логами и скажет, что он не может удалить (приведет еще причину, если вдруг там чего странного).
* `/deletePost` - используйте через `reply` сообщения с текстом `Post registered`, будет удален пост
вместе с его сообщениями. Важно: `/startPost`/`/fixPost` таким образом не удаляются - их нужно чистить
вручную.
* `/mostRated` - выводит список самых топовых на данный момент постов. Если ваша планерка - не публичный
канал, топовые посты будут переотправлены. Обычно можно нажать на название после `forwarded from` и
вам откроется сам пост.
* `/availableRatings` - выводит список пар "рейтинг" - "число постов", зарегестрированных в системе
* `/publishPost` - команда, используемая для немедленной публикации пост(а)(ов). Может использоваться в
трех вариантах:
    * `/publishPost` - публикуется один пост из тех, что выбираются выбиралкой из конфига
    * `/publishPost [число]` - публикается какое-то число постов, выбранных выбиралкой из конфига.
    Стоит учесть, что при первом совпадении между уже выбранными командой и выданным ей списком из
    выбиралки команда прекращает выборку и публикует то, что уже выбрано
    * `/publishPost` с `reply` какого-то из постов (как для deletePost) - публикует только выбранный пост

## Заметки

Бот игнорирует сообщения, начинающиеся с `/` и не являющиеся известной ему командой. Это значит, что
какие-то объявления можно писать, начиная сообщение со знака `/`. Учтите, что если вам понадобится
закрепить такое сообщение - сообщение о закреплении будет являться полноценным сообщением и будет
отмечено как пост. В таком случае его следует удалить как пост - через команду `/deletePost`.

